<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>垃圾监测终端</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <style>
        body { font-family: sans-serif; background: #222; color: white; text-align: center; padding: 10px; margin: 0; }
        h3 { margin: 10px 0; font-size: 16px; color: #aaa; }
        
        /* 实时画面区域 */
        .live-card { background: #333; padding: 10px; border-radius: 10px; margin-bottom: 20px; }
        #stream-img { width: 100%; background: #000; min-height: 200px; border-radius: 5px; object-fit: contain; }
        .live-tag { color: #0f0; font-size: 12px; font-weight: bold; margin-bottom: 5px; display: block;}

        /* 报警区域 */
        #alert-section { display: none; background: #5a1a1a; padding: 10px; border-radius: 10px; border: 2px solid #ff4444; }
        #alert-img { width: 100%; border-radius: 5px; filter: grayscale(20%); }
        .alert-title { color: #ff4444; font-weight: bold; margin-bottom: 5px; font-size: 18px; }
        .alert-time { font-size: 12px; color: #ccc; margin-top: 5px; }

        .status { font-size: 12px; color: #666; margin-top: 20px; }
    </style>
</head>
<body>

    <!-- 1. 实时画面 -->
    <div class="live-card">
        <span class="live-tag">● 实时监控画面</span>
        <img id="stream-img" src="" alt="等待信号..." />
    </div>

    <!-- 2. 溢出报警图 (平时隐藏) -->
    <div id="alert-section">
        <div class="alert-title">⚠️ 检测到垃圾溢满</div>
        <img id="alert-img" src="" />
        <div class="alert-time" id="alert-time">--</div>
    </div>

    <div class="status" id="conn-status">正在连接服务器...</div>

    <script>
        // ✅ 基础 Topic
        const BASE_TOPIC = "2428510019ljz";
        
        const BROKER = "broker.emqx.io";
        const PORT = 8084; // SSL

        const streamImg = document.getElementById("stream-img");
        const alertSection = document.getElementById("alert-section");
        const alertImg = document.getElementById("alert-img");
        const alertTime = document.getElementById("alert-time");
        const connStatus = document.getElementById("conn-status");

        const client = new Paho.MQTT.Client(BROKER, PORT, "web_" + Math.random().toString(16).substr(2, 8));

        function onConnect() {
            console.log("Connected");
            connStatus.innerText = "✅ 服务器已连接";
            // 订阅两个 Topic：一个流，一个报警
            client.subscribe(BASE_TOPIC + "/stream");
            client.subscribe(BASE_TOPIC + "/alert");
        }

        function onMessageArrived(message) {
            try {
                const topic = message.destinationName;
                const payload = JSON.parse(message.payloadString);

                // 判断是实时流 还是 报警
                if (topic.includes("/stream")) {
                    // 更新上面那张大图
                    streamImg.src = "data:image/jpeg;base64," + payload.image;
                } 
                else if (topic.includes("/alert")) {
                    // 显示下面那个红色的报警框
                    alertSection.style.display = "block";
                    alertImg.src = "data:image/jpeg;base64," + payload.image;
                    
                    const date = new Date(payload.timestamp * 1000);
                    alertTime.innerText = "报警时间: " + date.toLocaleTimeString();
                    
                    // 震动一下手机提示 (如果支持)
                    if (navigator.vibrate) navigator.vibrate(500);
                }

            } catch (e) { console.error(e); }
        }

        client.onConnectionLost = (e) => {
            connStatus.innerText = "❌ 断开连接，重连中...";
        };

        client.onMessageArrived = onMessageArrived;

        client.connect({
            useSSL: true,
            onSuccess: onConnect,
            keepAliveInterval: 30
        });

    </script>
</body>
</html>
